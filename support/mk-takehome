#! /bin/bash

SRC=$HOME/src/bash/src
REMHOST=jenna
DROPBOX_FOLDER='Dropbox (Personal)'
DROPBOX_HOME=$HOME/$DROPBOX_FOLDER
GDRIVE_FOLDER='Google Drive personal'
GDRIVE_HOME=$HOME/$GDRIVE_FOLDER

PARENT=/fs2/chet/bash
DATE=$(date +%Y%m%d)
fflag= sflag= dflag= gflag=

while getopts "dfgsp:D:" opt
do
	case $opt in
	d)	dflag=1 ;;
	g)	gflag=1 ;;
	f)	fflag=1 ;;
	p)	PARENT=$OPTARG
		if [ ! -d "$PARENT" ]; then
			echo "mk-takehome: $PARENT: directory does not exist" 2>&1
			exit 2
		fi ;;
	s)	sflag=1 ;;
	D)	DATE=$OPTARG ;;
	*)	echo "mk-takehome: usage: mk-takehome [-dfgs] [-p parent] [-D date] [directory]" 2>&1
		exit 2;;
	esac
done
shift $(($OPTIND - 1))

FROOT=bash-$DATE
DIR=$PARENT/$FROOT

if [ -n "$1" ]; then
	DIR="$1"
	PARENT="${DIR%/*}"
	FROOT="${DIR##*/}"
	if [ -z "$PARENT" ]; then PARENT=. ; fi
	if [ "$PARENT" -ef "$DIR" ]; then PARENT=. ; fi
fi
TARF=${FROOT}.tar

if [ -n "$fflag" ]; then
	rm -rf "$DIR"
fi

mkdir $DIR || exit 1

cd $DIR || exit 1

cd $SRC || exit 1

tar cf - . | (cd $DIR ; tar xvpf - )

cd $DIR || exit 1

find . -type f -name '*~' -print | xargs rm -f

find . -type d -name 'savedir' -print | xargs rm -rf

rm parser-built y.tab.c y.tab.h
# bison -y -d parse.y		# make sure y.tab.h present for dependencies

rm -f d d? ddd ddd?		# convention for temp diff files

cd $PARENT || exit 1

tar cvf ${TARF} $FROOT

gzip -v ${TARF}

if [ -n "$sflag" ]; then
	scp ${TARF}.gz ${REMHOST}:
fi

# dropbox
if [ -n "$dflag" ]; then
	if [ ! -d "$DROPBOX_HOME" ]; then
		HOME=~chet
		DROPBOX_HOME=$HOME/$DROPBOX_FOLDER
	fi
	if [ ! -d "$DROPBOX_HOME" ]; then
		echo "$DROPBOX_HOME: directory not found" >&2
	else
		cp ${TARF}.gz "$DROPBOX_HOME"
	fi
fi

# google drive
if [ -n "$gflag" ]; then
	if [ ! -d "$GDRIVE_HOME" ]; then
		HOME=~chet
		GDRIVE_HOME=$HOME/$GDRIVE_FOLDER
	fi
	if [ ! -d "$GDRIVE_HOME" ]; then
		echo "$GDRIVE_HOME: directory not found" >&2
	else
		cp ${TARF}.gz "$GDRIVE_HOME"
	fi
fi
